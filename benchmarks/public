#!/usr/bin/env bash
#
# Wrapper script to run programs on public machines

set -u

args=$@

user=$USER
pid=$$
email=chrisc.101@gmail.com

if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root." 1>&2
    exit 1
fi

# Temporary message of the day.
cat <<EOF > .motd.current

Ahoy there! User $user is currently running timed benchmarks on this
machine. To minimise noise, please kill process $pid before running
CPU/GPU intensive tasks. This message will reset once the experiment
has completed. Many thanks!

Contact: $email

EOF

# Always run
tidyup() {
    echo "Tidying up..."
    if [[ -f .motd.backup ]]; then
        cp .motd.backup /etc/motd
    fi

    rm -f .motd.backup
    rm -f .motd.current
}

trap tidyup EXIT

echo "Setting message of the day..."
cp /etc/motd .motd.backup
cp .motd.current /etc/motd

$args
exit $?
