#!/usr/bin/env python

from os import system,chdir
from subprocess import check_output

def readlines(path):
    with open(path) as f:
        return [x.strip() for x in f.readlines()]

flags = readlines('etc/flags.txt')
benchmarks = readlines('etc/benchmarks.txt')

for flag in flags:
    system("sed -i -r 's/(CHRIS_OPENCL_FLAG \")(.*)(\")"
           "/\1{flag}\3/' '../skelcl/include/SkelCL/Chris.h'"
           .format(flag=flag))

    # Build SkelCL
    chdir("../skelcl/build/")
    system("make >/dev/null")
    chdir("../../benchmarks/")

    # Build benchmarks.
    chdir("src/")
    system("make clean >/dev/null")
    system("make >/dev/null")
    chris("../")

    # Evaluate benchmarks.
    for benchmark in benchmarks:
        datadir="dat/{0}".format(benchmark)
        checksum=check_output("echo {0} | sha256sum | cut -d' ' -f1"
                              .format(flag)).strip()
        datafile="/".join(datadir, checksum)

        system("mkdir -p {0}".format(datadir))
        print(benchmark, flag, checksum)
        system("./{0} | tee {1}".format(benchmark, datafile))
