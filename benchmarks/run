#!/usr/bin/env bash

set -eu

while read flag; do
    sed -i -r 's/(CHRIS_OPENCL_FLAG ")(.*)(")/\1'"$flag"'\3/' '../skelcl/include/SkelCL/Chris.h'

    # Build SkelCL.
    cd ../skelcl/build/
    make >/dev/null
    cd ../../benchmarks

    # Build benchmarks.
    cd src/
    make clean >/dev/null
    make >/dev/null
    cd ..

    # Evaluate benchmarks.
    while read benchmark; do
        datadir=dat/$benchmark
        checksum=$(echo $flag | sha256sum | cut -d' ' -f1)
        datafile=$datadir/$checksum

        mkdir -p $datadir
        echo "$benchmark $flag $checksum"
        ./$benchmark | tee $datafile
    done < benchmarks.txt
done < flags.txt
