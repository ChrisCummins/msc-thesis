%%%%%%%%%%%%%%%%%%%%%%
%% Document details %%
%%%%%%%%%%%%%%%%%%%%%%

% Paper title
\title{SkelCL Initial Performance Results}

% Author
\author{Chris Cummins}

\input{preamble}

%%%%%%%%%%
%% Body %%
%%%%%%%%%%
\begin{document}

\maketitle

\begin{abstract}
  \noindent
  This document describes my methodology for collecting performance
  data of SkelCL applications, and proposes

  experimental results from two applications show a maximum speedup of
  3.8$\times$ (average: 1.77$\times$).
\end{abstract}

\section{Profiling SKelCL programs}

\begin{itemize}
\item \textbf{init}
\item \textbf{build}
\item \textbf{prep}
\end{itemize}

Measured using profiling information from the OpenCL
API\footnote{\url{https://www.khronos.org/registry/cl/sdk/1.2/docs/man/xhtml/clGetEventProfilingInfo.html}}. \texttt{COMMAND\_START}
and \texttt{COMMAND\_END} event timestamps.

\begin{itemize}
\item \textbf{upload}
\item \textbf{run}
\item \textbf{download}
\end{itemize}

\begin{figure}
\centering
\includesvg[width=.8\textwidth]{img/GameOfLife-cec-c9b9bcf6c928d805a0730f1789fe205b2f39fc09-events}
\caption{%
Profiling information for.%
}
\label{fig:events}
\end{figure}

\section{Tuning iterative stencil applications}

\lstset{language=C++}
\begin{lstlisting}[
  caption={Source code to implement \texttt{GameOfLife} using the Stencil skeleton.},
  label=lst:gol-stencil
]
Matrix<int> grid(data, numcols);
Stencil<int(int)> s(std::ifstream{"./Stencil.cl"}, 1, 1, 1, 1,
                    detail::Padding::NEUTRAL, 0, "func", 0);

grid = s(iterations, grid);
\end{lstlisting}

\lstset{language=C++}
\begin{lstlisting}[
  caption={Implementing the same algorithm as Listing~\ref{lst:gol-stencil}, but using the MapOverlap skeleton.}
]
Matrix<int> grid(data, numcols);
MapOverlap<int(int)> s(std::ifstream{"./MapOverlap.cl"}, 1,
                       detail::Padding::NEUTRAL, 0, "func");

for (int i = 0; i < iterations; i++) {
  grid = s(grid);
}
\end{lstlisting}

\newpage
\lstset{language=C++}
\begin{lstlisting}[
  caption={My proposed ``SmartStencil'' implementation.},
  label=lst:gol-stencil
]
// Constructor declaration.
MyStencil<DataType>(kernel, border={0,0,0,0}, padding_type=NEUTRAL);

// "()" operator definition.
DataType MyStencil::operator()(DataType in, iterations=1) {
  if (max(border) == 0 && iterations == 1) {
    // Use Map skeleton
  } else if (iterations < TUNABLE_KNOB) {
    // Use MapOverlap skeleton
  } else {
    // Use Stencil skeleton
  }
}
\end{lstlisting}

\begin{figure}
\includesvg[width=.5\textwidth]{img/GameOfLife-cec-f679f681af6ac3f41dc4f2284ed2039e0a79579a-events}
\includesvg[width=.5\textwidth]{img/GameOfLife-cec-8c5a7452d26b8294e841b29e0e749c40944fd69b-events}
\caption{Problem size of 4096 elements. MapOverlap is 95\% faster.}
\label{fig:}
\end{figure}

\begin{figure}
\includesvg[width=.5\textwidth]{img/GameOfLife-cec-0ed9d7941c644e44e34aab38b6ea031c1f2f0a9f-events}
\includesvg[width=.5\textwidth]{img/GameOfLife-cec-f88ff13f204fa812571941a74a7cf72941f96fb8-events}
\caption{Problem size of 4096 elements. MapOverlap is 64\% slower.}
\label{fig:}
\end{figure}

\begin{table}
\footnotesize
\centering
\begin{tabular}{| l | l | l | l | l |}
\hline
\textbf{CPU} & \textbf{Memory} & \textbf{GPUs} & \textbf{Name}\\
\hline
Intel i7-4770 & 16GiB & NVIDIA GTX TITAN & \textit{whz5}\\
Intel i7-2600K & 16GiB & NVIDIA GTX 690 & \textit{dhcp-60-090}\\
Intel i7-2600K & 8GiB & 2$\times$ NVIDIA GTX 590 & \textit{tim}\\
Intel i7-3820 & 8GiB & 2$\times$ AMD Tahiti 7970 & \textit{monza}\\
Intel i5-4570 & 8GiB & - & \textit{cec}\\
\hline
\end{tabular}
\caption{%
  Testing hardware.%
}
\label{tab:hw}
\end{table}

Table~\ref{tab:breakeven} shows the ``break-even'' point between

\begin{table}
\footnotesize
\centering
\input{../../benchmarks/results/e8/MapOverlapVsStencilSpeedups.tex}
\caption{%
  Relative performance of MapOverlap vs Stencil skeletons for over an
  increasing number of iterations. The ``Break-even point'' is the number of
  iterations at which point the Stencil kernel is faster than MapOverlap.%
}
\label{tab:breakeven}
\end{table}

\begin{figure}
\includegraphics[width=.5\textwidth]{/home/chris/src/msc-thesis/benchmarks/results/e8/cec-CPU-GameOfLife-2048.png}
\includegraphics[width=.5\textwidth]{/home/chris/src/msc-thesis/benchmarks/results/e8/cec-CPU-HeatEquation-2048.png}
\caption{%
  Relative performance of the MapOverlap skeleton over the Stencil
  skeleton, for two different benchmarks on the same architecture.%
}
\end{figure}

\begin{figure}
\includegraphics[width=.5\textwidth]{/home/chris/src/msc-thesis/benchmarks/results/e8/monza-1xGPU-HeatEquation-1024.png}
\includegraphics[width=.5\textwidth]{/home/chris/src/msc-thesis/benchmarks/results/e8/tim-1xGPU-HeatEquation-1024.png}
\caption{%
  The same program and input size for two different CP/GPU
  architectures.%
}
\end{figure}
% \begin{table}
% \footnotesize
% \centering
% \begin{tabular}{| l | l | l | l | l |}
% \hline
% \textbf{Name} & \textbf{Application} & \textbf{Skeletons used} & \textbf{Iterative?} & \textbf{LOC}\\
% \hline
% CannyEdgeDetection & Image processing & Stencil & - & 225 / 61\\
% DotProduct & Linear algebra & Zip, Reduce & - & 143 / 2\\
% FDTD & Scientific simulation & Map, Stencil & Y & 375 / 127\\
% GameOfLife & Cellular automata & Stencil & Y & 92 / 12\\
% GaussianBlur & Image processing & Stencil & - & 262 / 47\\
% HeatSimulation & Scientific simulation & Stencil & Y & 180 / 13\\
% MandelbrotSet & Fractal computation & Map & Y & 133 / 78\\
% MatrixMultiply & Linear algebra & AllPairs & - & 267 / 8\\
% SAXPY & Linear algebra & Zip & - & 149 / 3\\
% \hline
% \end{tabular}
% \caption{Benchmark applications. The LOC column shows lines of code, split between host (C++) and device (OpenCL).}
% \label{tab:benchmarks}
% \end{table}


\section{Conclusions}

Future work: ``fusing'' kernels of multi-stage iterative skeletons,
and tuning halo size for multi-GPU systems and .

Also, investigate seg faults in multi-GPU stencil computations.

\label{bibliography}
\printbibliography
\end{document}
